---
title: "Almond_Profit_Function"
author: "Madison Enda"
date: 04/20/2025
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

Load in the initial data and relevant packages

```{r}
library(tidyverse)
library(here)
library(janitor)
```

```{r}
climate_data <- read_table(here("data", "clim.txt")) %>% clean_names()
```

1.) Bring in the almond yield model

```{r}
#' Calculate Almond Yield
#'
#' @description Computes the maximum, minimum, and mean almond yield for each year 
#' based on climate data inputs such as minimum February temperature and January precipitation.
#'
#' @author Madison Enda and Joshua Mull for EDS230 with Naomi Tague
#' 
#' @param climate_data A data frame containing climate data with columns for `month`, `year`, 
#' `tmin_c` (minimum daily temperature in Celsius), and `precip` (daily precipitation in millimeters).
#' @param Tn1 Coefficient for the minimum February temperature.
#' Default is -0.015.
#' @param Tn2 Quadratic term coefficient of the minimum February temperature.
#' Default is -0.0046.
#' @param P1 Coefficient for January precipitation. Default is -0.07.
#' @param P2 Quadratic term coefficient of January precipitation. Default is 0.0043.
#' @param i Intercept term 0.28.
#'
#' @return A list containing: min, max and mean almond yields across all years 

almond_yield <- function(climate_data, Tn1 = -0.015, Tn2 = -0.0046, P1 = -0.07, P2 = 0.0043, i = 0.28) {
  
  # filter data for min temp in February 
  feb_temp <- climate_data %>%
    filter(month == 2) %>% 
    group_by(year) %>%
    summarize(min_feb_temp_c = min(tmin_c, na.rm = TRUE), .groups = "drop") 
  
  # filter data for total rain in January 
  jan_p <- climate_data %>%
    filter(month == 1) %>% 
    group_by(year) %>% 
    summarize(jan_precip = sum(precip, na.rm = TRUE), .groups = "drop") 
  
  # join data frames 
  climate_data_jan_feb <- left_join(feb_temp, jan_p, by = "year")
  
  # Compute yield for each year
  climate_data_jan_feb <- climate_data_jan_feb %>%
    mutate(yield = Tn1 * min_feb_temp_c + Tn2 * min_feb_temp_c^2 + P1 * jan_precip + P2 * jan_precip^2 + i)
  
  # Compute max, min, mean result
    maxyield <- max(climate_data_jan_feb$yield, na.rm = TRUE)
    minyield <- min(climate_data_jan_feb$yield, na.rm = TRUE)
    meanyield <- mean(climate_data_jan_feb$yield, na.rm = TRUE)
  
  # Return max, min, and mean yields
  return(meanyield)
}
```

Create data frame of average price per lbs of California almonds by year. Data sources from USDA and Merlo Farming Group: https://www.nass.usda.gov/Statistics_by_State/California/Publications/Specialty_and_Other_Releases/Almond/Forecast/202405almpd.pdf https://www.merlofarminggroup.com/almonds/Independence

Create an almond profit model that utilizes outputs from the almond yield model

```{r}
#' computes profit from power generation
#' @param farm_size (acres of farm land)
#' @param year (year when almonds were harvested, from 1995-2025)
#' @param meanyield (result from almond_yield function)
#' @return meanprofit 
profit_from_almond_yield <- function(farm_size, year) {

  # Create vectors of year and price
  date <- c(1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025)
  price <- c(2.48, 2.08, 1.56, 1.41, 0.86, 0.97, 0.91, 1.11, 1.57, 2.21, 2.81, 2.06, 1.75, 1.45, 1.65, 1.79, 1.99, 2.58, 3.21, 4.00, 3.13, 2.39, 2.53, 2.50, 2.45, 1.71, 1.86, 1.40, 1.64, 1.91, 2.60)
  
  # Join vectors in data frame
  almond_price <- data.frame(date, price)
  
  # Create a column that is price per ton
  almond_price <- almond_price %>%
  mutate(price_per_ton = price * 2000 )

 # Filter the data to year parameter
  almond_price_filtered <- almond_price %>%
    filter(date == year)
  
  # Call almond yield function to find meanyield
  meanyield <- almond_yield(climate_data)
  
  # Use the price per ton from subsequent year to find price by acres and 
  meanprofit <- meanyield * farm_size *  almond_price_filtered$price_per_ton
  
  return(meanprofit)
}
```

2.) Apply profit model to the almond model

```{r}
profit_from_almond_yield(farm_size= 50, year= 1999)
```

3.) Sensitivity analysis of the almond profit model

For this analysis we used 383 acres as the average farm size in California according to farmflavor.com found here 

[Farm Flavor](https://farmflavor.com/california/top-california-agriculture-facts/)


```{r}
date <- c(1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025)
price <- c(2.48, 2.08, 1.56, 1.41, 0.86, 0.97, 0.91, 1.11, 1.57, 2.21, 2.81, 2.06, 1.75, 1.45, 1.65, 1.79, 1.99, 2.58, 3.21, 4.00, 3.13, 2.39, 2.53, 2.50, 2.45, 1.71, 1.86, 1.40, 1.64, 1.91, 2.60)
  
# Join vectors in data frame
almond_price <- data.frame(date, price)
  
# Create a column that is price per ton
almond_price <- almond_price %>%
mutate(price_per_ton = price * 2000)
```

```{r}
year_variation_profit <- profit_from_almond_yield(farm_size = 383, year = date)

year_variation_df <- data.frame(ave_acre_profit, date) %>%
  mutate(z_score = scale(ave_ap_df$ave_acre_profit))



numbers <- c(
  250, 350, 400, 500, 600, 300, 450, 390, 370, 410,
  420, 360, 430, 395, 380, 405, 470, 490, 375, 385,
  415, 440, 320, 340, 520, 310, 395, 450, 480, 370, 400
)


ave_acre_profit <- profit_from_almond_yield(farm_size = numbers, year = 2011)
print(ave_acre_profit)

ave_acre_profit_df <-  data.frame(ave_acre_profit, year = 2011) %>%
  mutate(z_score = scale(ave_acre_profit_df$ave_acre_profit))
```


4.) First graph of almond profit model that shows yield anomaly for each year, accounting for uncertainty in the parameters

```{r}

```

Second graph of almond profit model that shows how yield anomaly in general varies with your parameters

```{r}

```

5.  Write a short paragraph (in a Quatro document) to summarize you interpretation of your model results (e.g what do 'take away' from your model and sensitivity analysis)

```{r}

```

